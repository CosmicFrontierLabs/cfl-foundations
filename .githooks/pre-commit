#!/bin/bash
# Pre-commit hook to run cargo fmt, check, and clippy
#
# This matches the CI checks in .github/workflows/

set -e

echo "Checking if code is properly formatted..."

# Check if any Rust files are staged
if git diff --cached --name-only | grep -q '\.rs$'; then
    # Run cargo fmt check (show output on failure, matching CI)
    fmt_output=$(cargo fmt --all -- --check 2>&1)
    if [ $? -ne 0 ]; then
        echo "❌ Code is not properly formatted!"
        echo "$fmt_output"
        echo ""
        echo "Please run 'cargo fmt --all' before committing."
        exit 1
    fi
    echo "✅ Code formatting is correct."

    # Run cargo check (matching CI)
    echo "Running cargo check..."
    if ! cargo check --locked --all-targets; then
        echo ""
        echo "========================================"
        echo "❌ CARGO CHECK FAILED!"
        echo "========================================"
        echo ""
        exit 1
    fi
    echo "✅ Cargo check passed."

    # Run cargo clippy with warnings as errors (show output on failure, matching CI)
    echo "Running clippy checks..."
    if ! cargo clippy -- -D warnings; then
        echo ""
        echo "========================================"
        echo "❌ CLIPPY FOUND ISSUES!"
        echo "========================================"
        echo ""
        exit 1
    fi
    echo "✅ Clippy checks passed."

    # Check that there are no doctests (we use proper unit tests instead)
    echo "Checking for doctests (should be 0)..."
    doctest_output=$(cargo test --doc 2>&1)
    # Count lines that show non-zero test runs like "running 5 tests"
    doctest_count=$(echo "$doctest_output" | grep -E '^running [1-9][0-9]* tests?$' | wc -l)
    if [ "$doctest_count" -gt 0 ]; then
        echo "❌ Found doctests! We don't use doctests in this codebase."
        echo "$doctest_output" | grep -E '^running [1-9][0-9]* tests?$'
        echo ""
        echo "Please convert doctests to proper unit tests in #[cfg(test)] modules."
        exit 1
    fi
    echo "✅ No doctests found."
fi

exit 0
