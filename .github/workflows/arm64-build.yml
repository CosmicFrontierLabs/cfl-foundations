name: ARM64 Build (SelfHost)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

env:
  CARGO_TERM_COLOR: always

jobs:
  build-arm64:
    # Self-hosted ARM64 runner on cfl-test-bench
    # Setup: scripts/setup-github-runner.sh
    runs-on: [self-hosted, Linux, ARM64, arm64-builder]

    steps:
    - uses: actions/checkout@v4

    # No need to install Rust or system deps - pre-installed on self-hosted runner
    # See scripts/setup-github-runner.sh for dependency list

    - name: Check Rust version
      run: |
        source ~/.cargo/env
        rustc --version
        cargo --version

    - name: Build fgs_server (NSV455 camera)
      run: |
        source ~/.cargo/env
        cargo build --release --package test-bench --bin fgs_server --features nsv455,pi-fsm

    - name: Build fgs_server (PlayerOne camera)
      run: |
        source ~/.cargo/env
        cargo build --release --package test-bench --bin fgs_server --features playerone,pi-fsm
      continue-on-error: true  # May fail if libplayeronecamera2 not available

    - name: Build calibration_controller
      run: |
        source ~/.cargo/env
        cargo build --release --package test-bench --bin calibration_controller

    - name: List built binaries
      run: |
        echo "Built ARM64 binaries:"
        ls -lh target/release/fgs_server target/release/calibration_controller 2>/dev/null || true
        file target/release/fgs_server target/release/calibration_controller 2>/dev/null || true

    - name: Upload ARM64 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: arm64-binaries
        path: |
          target/release/fgs_server
          target/release/calibration_controller
        retention-days: 7
