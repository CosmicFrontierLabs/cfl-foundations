name: Frontend CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: test-bench-frontend

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown

    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-wasm-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-wasm-cargo-

    - name: Cache trunk tools
      uses: actions/cache@v4
      with:
        path: ~/.cache/trunk
        key: ${{ runner.os }}-trunk-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-trunk-

    - name: Ensure wasm target is installed
      run: rustup target add wasm32-unknown-unknown

    - name: Install wasm-bindgen-cli
      run: |
        WASM_BINDGEN_VERSION=$(grep -A1 'name = "wasm-bindgen"' ../Cargo.lock | grep version | head -1 | sed 's/.*"\(.*\)".*/\1/')
        echo "Installing wasm-bindgen-cli version $WASM_BINDGEN_VERSION"
        cargo install wasm-bindgen-cli --version "$WASM_BINDGEN_VERSION" --locked || true

    - name: Install Trunk
      uses: jetli/trunk-action@v0.4.0
      with:
        version: 'latest'

    - name: Build Calibrate App
      run: trunk build --config Trunk-calibrate.toml

    - name: Verify Calibrate Artifacts
      run: |
        echo "Listing dist/calibrate:"
        ls -R dist/calibrate
        if [ ! -f "dist/calibrate/index.html" ]; then
          echo "Error: dist/calibrate/index.html not found"
          exit 1
        fi
        if ! ls dist/calibrate/*.wasm 1> /dev/null 2>&1; then
          echo "Error: No .wasm file found in dist/calibrate"
          exit 1
        fi
        if ! ls dist/calibrate/*.js 1> /dev/null 2>&1; then
          echo "Error: No .js file found in dist/calibrate"
          exit 1
        fi

    - name: Build Camera App
      run: trunk build --config Trunk-camera.toml

    - name: Verify Camera Artifacts
      run: |
        echo "Listing dist/camera:"
        ls -R dist/camera
        if [ ! -f "dist/camera/index.html" ]; then
          echo "Error: dist/camera/index.html not found"
          exit 1
        fi
        if ! ls dist/camera/*.wasm 1> /dev/null 2>&1; then
          echo "Error: No .wasm file found in dist/camera"
          exit 1
        fi
        if ! ls dist/camera/*.js 1> /dev/null 2>&1; then
          echo "Error: No .js file found in dist/camera"
          exit 1
        fi
